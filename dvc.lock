schema: '2.0'
stages:
  create_pretraining_data:
    cmd: python src/create_pretraining_data.py --config=params.yaml
    deps:
    - path: src/create_pretraining_data.py
      hash: md5
      md5: 46854de467615cff9329b59e0761bbfa
      size: 704
    params:
      params.yaml:
        data.pretraining_parquet: data/raw/pretraining/train-00001-of-00002.parquet
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
    outs:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 2938ccdd6d68ddb37845a262020aa61f
      size: 270479474
  create_tokenizer:
    cmd: python src/create_tokenizer.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 2938ccdd6d68ddb37845a262020aa61f
      size: 270479474
    - path: src/create_tokenizer.py
      hash: md5
      md5: bf0af90be37de8d28f541c051108a21d
      size: 660
    params:
      params.yaml:
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
        data.vocab_dir: data/tokenizer/spm_model
        hyperparameters.vocab_size: 10000
    outs:
    - path: data/tokenizer/spm_model.model
      hash: md5
      md5: 7af9c385fcb3ced1bbe55c6b15890f33
      size: 409670
  create_pretraining_split:
    cmd: python src/create_pretraining_split.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 2938ccdd6d68ddb37845a262020aa61f
      size: 270479474
    - path: data/tokenizer/spm_model.model
      hash: md5
      md5: 7af9c385fcb3ced1bbe55c6b15890f33
      size: 409670
    - path: src/create_pretraining_split.py
      hash: md5
      md5: d5af4250321f5b62c7e52f981f225520
      size: 1323
    params:
      params.yaml:
        data.pretraining_train: data/raw/pretraining/pretraining_train.pkl
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
        data.pretraining_val: data/raw/pretraining/pretraining_val.pkl
        data.vocab_dir: data/tokenizer/spm_model
    outs:
    - path: data/raw/pretraining/pretraining_train.pkl
      hash: md5
      md5: 0070b22d1b69f11e4ad73fd0355c96e3
      size: 226282912
    - path: data/raw/pretraining/pretraining_val.pkl
      hash: md5
      md5: 520534386937c3074e1fbe05f41ec361
      size: 24426380
  training_pretraining:
    cmd: python src/training.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining_train.pkl
      hash: md5
      md5: 0070b22d1b69f11e4ad73fd0355c96e3
      size: 226282912
    - path: data/raw/pretraining/pretraining_val.pkl
      hash: md5
      md5: 520534386937c3074e1fbe05f41ec361
      size: 24426380
    - path: src/training.py
      hash: md5
      md5: 29a1cf0ccf32fc0d085bb1f3d387c4e6
      size: 4711
    params:
      params.yaml:
        data.pretraining_train: data/raw/pretraining/pretraining_train.pkl
        data.pretraining_val: data/raw/pretraining/pretraining_val.pkl
        hyperparameters.batch_size: 32
        hyperparameters.block_size: 128
        hyperparameters.dropout: 0.2
        hyperparameters.eval_interval: 100
        hyperparameters.eval_iters: 50
        hyperparameters.learning_rate: 0.0001
        hyperparameters.max_iters: 100
        hyperparameters.n_embd: 512
        hyperparameters.n_head: 8
        hyperparameters.n_layer: 8
        hyperparameters.vocab_size: 10000
        mlflow_pretraining.experiment_name: Pretraining
        mlflow_pretraining.registered_model_name: Pretrained GPT
        mlflow_pretraining.run_name: 1st
        mlflow_pretraining.server_uri: sqlite:///mlflow.db
    outs:
    - path: training_completion.txt
      hash: md5
      md5: 8132d890ed809c771d6ca9558b0ab46d
      size: 41
  log_pretraining_model:
    cmd: python src/log_pretraining_model.py --config=params.yaml
    deps:
    - path: src/log_pretraining_model.py
      hash: md5
      md5: 4b580361fdbe807c154f56f37b56aafe
      size: 1102
    - path: training_completion.txt
      hash: md5
      md5: 8132d890ed809c771d6ca9558b0ab46d
      size: 41
    params:
      params.yaml:
        mlflow_pretraining.experiment_name: Pretraining
        mlflow_pretraining.server_uri: sqlite:///mlflow.db
    outs:
    - path: saved_models/pretrained.pth
      hash: md5
      md5: 382a00e4730119a0414e264fe8dac3fc
      size: 146466066
  create_summary_data:
    cmd: python src/create_summary_data.py --config=params.yaml
    deps:
    - path: data/raw/summary/train-00000-of-00002.parquet
      hash: md5
      md5: 0f48652dbd5ff287cc94e40944524d21
      size: 167815407
    - path: src/create_summary_data.py
      hash: md5
      md5: d6fceb53c4a7665c938daf05d07608b2
      size: 1407
    params:
      params.yaml:
        data.summarization_parquet: data/raw/summary/train-00000-of-00002.parquet
        data.vocab_dir: data/tokenizer/spm_model
        hyperparameters.block_size: 128
    outs:
    - path: data/raw/summary/filtered.parquet
      hash: md5
      md5: 8e8f8dea46cf916fae032b0efc8b6459
      size: 2033171
