schema: '2.0'
stages:
  create_pretraining_data:
    cmd: python src/create_pretraining_data.py --config=params.yaml
    deps:
    - path: src/create_pretraining_data.py
      hash: md5
      md5: 46854de467615cff9329b59e0761bbfa
      size: 704
    params:
      params.yaml:
        data.pretraining_parquet: data/raw/pretraining/train-00001-of-00002.parquet
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
    outs:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 2938ccdd6d68ddb37845a262020aa61f
      size: 270479474
  create_tokenizer:
    cmd: python src/create_tokenizer.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 6f83785aa68dc81b75faa37aa0af1a85
      size: 679267164
    - path: src/create_tokenizer.py
      hash: md5
      md5: b55477e09d3aa16af6de159eb767d493
      size: 724
    params:
      params.yaml:
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
        data.vocab_dir: data/tokenizer/spm_model
        hyperparameters.vocab_size: 15000
    outs:
    - path: data/tokenizer/spm_model.model
      hash: md5
      md5: 3b6f948eb6f3add479f6a8dd74fe1276
      size: 512172
  create_pretraining_split:
    cmd: python src/create_pretraining_split.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 6f83785aa68dc81b75faa37aa0af1a85
      size: 679267164
    - path: src/create_pretraining_split.py
      hash: md5
      md5: 141a7e355a1b545cfaab277d003b38b7
      size: 1285
    params:
      params.yaml:
        data.pretraining_train: data/raw/pretraining/pretraining_train.pkl
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
        data.pretraining_val: data/raw/pretraining/pretraining_val.pkl
    outs:
    - path: data/raw/pretraining/pretraining_train.pkl
      hash: md5
      md5: c1d4955f4d4763889577798d9332764b
      size: 296949960
    - path: data/raw/pretraining/pretraining_val.pkl
      hash: md5
      md5: 2066eaae8ef621307e6b209283ae7f23
      size: 126730194
  training_pretraining:
    cmd: python src/training.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining_train.pkl
      hash: md5
      md5: c1d4955f4d4763889577798d9332764b
      size: 296949960
    - path: data/raw/pretraining/pretraining_val.pkl
      hash: md5
      md5: 2066eaae8ef621307e6b209283ae7f23
      size: 126730194
    - path: src/training.py
      hash: md5
      md5: 517c5187ba1f6dd34a4de18704615099
      size: 4729
    params:
      params.yaml:
        data.pretraining_train: data/raw/pretraining/pretraining_train.pkl
        data.pretraining_val: data/raw/pretraining/pretraining_val.pkl
        hyperparameters.batch_size: 16
        hyperparameters.block_size: 128
        hyperparameters.dropout: 0.2
        hyperparameters.eval_interval: 500
        hyperparameters.eval_iters: 100
        hyperparameters.learning_rate: 0.0005
        hyperparameters.max_iters: 30000
        hyperparameters.n_embd: 256
        hyperparameters.n_head: 8
        hyperparameters.n_layer: 8
        hyperparameters.vocab_size: 50259
        mlflow_pretraining.experiment_name: Pretraining
        mlflow_pretraining.registered_model_name: Pretrained GPT
        mlflow_pretraining.run_name: 1st
        mlflow_pretraining.server_uri: sqlite:///mlflow.db
    outs:
    - path: training_completion.txt
      hash: md5
      md5: 2452299d926e3aa75c66aa6ce2439111
      size: 41
  log_pretraining_model:
    cmd: python src/log_pretraining_model.py --config=params.yaml
    deps:
    - path: src/log_pretraining_model.py
      hash: md5
      md5: 4b580361fdbe807c154f56f37b56aafe
      size: 1102
    - path: training_completion.txt
      hash: md5
      md5: 2452299d926e3aa75c66aa6ce2439111
      size: 41
    params:
      params.yaml:
        mlflow_pretraining.experiment_name: Pretraining
        mlflow_pretraining.server_uri: sqlite:///mlflow.db
    outs:
    - path: saved_models/pretrained.pth
      hash: md5
      md5: 63d26e6254a6146ef5290978c44f9216
      size: 132885074
  create_summary_data:
    cmd: python src/create_summary_data.py --config=params.yaml
    deps:
    - path: data/raw/summary/train.src.txt
      hash: md5
      md5: c5ec83e27d31f37ddc299f22c68126ca
      size: 695194407
    - path: data/raw/summary/train.tgt.txt
      hash: md5
      md5: 698a3c20b54e8fdb19acdc60c9b676ef
      size: 198500841
    - path: src/create_summary_data.py
      hash: md5
      md5: f9ec66abfbfbfcac516b627226e14e20
      size: 2792
    params:
      params.yaml:
        data.summarization_full_txt: data/raw/summary/train.src.txt
        data.summarization_summary_txt: data/raw/summary/train.tgt.txt
        data.vocab_dir: data/tokenizer/spm_model
        hyperparameters.block_size: 128
    outs:
    - path: data/raw/summary/filtered.parquet
      hash: md5
      md5: eef96fc6eb39d84f775cbfc42cab5a5f
      size: 6112404
  create_summary_split:
    cmd: python src/create_summary_split.py --config=params.yaml
    deps:
    - path: data/raw/summary/filtered.parquet
      hash: md5
      md5: eef96fc6eb39d84f775cbfc42cab5a5f
      size: 6112404
    - path: src/create_summary_split.py
      hash: md5
      md5: ca0a2443e15cfb1e3028c62e44af5ca0
      size: 1392
    params:
      params.yaml:
        data.summarization_filtered_parquet: data/raw/summary/filtered.parquet
        data.train_full: data/raw/summary/train_full.pkl
        data.train_summary: data/raw/summary/train_summary.pkl
        data.val_full: data/raw/summary/val_full.pkl
        data.val_summary: data/raw/summary/val_summary.pkl
    outs:
    - path: data/raw/summary/train_full.pkl
      hash: md5
      md5: 6c2dc73ea3e5d755691d2cf437de765a
      size: 42285986
    - path: data/raw/summary/train_summary.pkl
      hash: md5
      md5: 600c08956845d94e1174bc8aa19fe7ac
      size: 42285986
    - path: data/raw/summary/val_full.pkl
      hash: md5
      md5: fa8628c32313ee4e630379ac729d6605
      size: 10571579
    - path: data/raw/summary/val_summary.pkl
      hash: md5
      md5: bdec48d792078362bef6081a42202f00
      size: 10571579
  summary_training:
    cmd: python src/summary_training.py --config=params.yaml
    deps:
    - path: data/raw/summary/train_full.pkl
      hash: md5
      md5: 6c2dc73ea3e5d755691d2cf437de765a
      size: 42285986
    - path: data/raw/summary/train_summary.pkl
      hash: md5
      md5: 600c08956845d94e1174bc8aa19fe7ac
      size: 42285986
    - path: data/raw/summary/val_full.pkl
      hash: md5
      md5: fa8628c32313ee4e630379ac729d6605
      size: 10571579
    - path: data/raw/summary/val_summary.pkl
      hash: md5
      md5: bdec48d792078362bef6081a42202f00
      size: 10571579
    - path: saved_models/pretrained.pth
      hash: md5
      md5: 63d26e6254a6146ef5290978c44f9216
      size: 132885074
    - path: src/summary_training.py
      hash: md5
      md5: efc3c181cafccca26ea7f183284545b7
      size: 4613
    - path: training_completion.txt
      hash: md5
      md5: 2452299d926e3aa75c66aa6ce2439111
      size: 41
    params:
      params.yaml:
        data.train_full: data/raw/summary/train_full.pkl
        data.train_summary: data/raw/summary/train_summary.pkl
        data.val_full: data/raw/summary/val_full.pkl
        data.val_summary: data/raw/summary/val_summary.pkl
        hyperparameters.block_size: 128
        hyperparameters.eval_interval: 500
        hyperparameters.eval_iters: 100
        log_pretrained_model.model_dir: saved_models/pretrained.pth
        mlflow_summary.experiment_name: Summary
        mlflow_summary.registered_model_name: Summary GPT
        mlflow_summary.run_name: 1st
        mlflow_summary.server_uri: sqlite:///mlflow.db
        summary_hyperparameters.batch_size: 16
        summary_hyperparameters.learning_rate: 0.0001
        summary_hyperparameters.max_iters: 10000
    outs:
    - path: training_summary_completion.txt
      hash: md5
      md5: 59ec4fa1dcebc02119d68ca96399d76a
      size: 41
  log_summary_model:
    cmd: python src/log_summary_model.py --config=params.yaml
    deps:
    - path: src/log_summary_model.py
      hash: md5
      md5: dabbdf6f258b35c1a41eb8f468e02fcd
      size: 1091
    - path: training_summary_completion.txt
      hash: md5
      md5: 59ec4fa1dcebc02119d68ca96399d76a
      size: 41
    params:
      params.yaml:
        mlflow_summary.experiment_name: Summary
        mlflow_summary.server_uri: sqlite:///mlflow.db
    outs:
    - path: saved_models/summary.pth
      hash: md5
      md5: 2869e7ab4745a2a9541b71a99a282283
      size: 132884434
  clean_and_tokenize_pretraining_data:
    cmd: python src/clean_and_tokenize_pretraining_data.py --config=params.yaml
    deps:
    - path: data/raw/summary/train.src.txt
      hash: md5
      md5: c5ec83e27d31f37ddc299f22c68126ca
      size: 695194407
    - path: src/clean_and_tokenize_pretraining_data.py
      hash: md5
      md5: 6251e4049bb1699becf3333c3761c548
      size: 2021
    params:
      params.yaml:
        data.pretraining_pkl: data/raw/pretraining/pretraining.pkl
        data.summarization_full_txt: data/raw/summary/train.src.txt
    outs:
    - path: data/raw/pretraining/pretraining.pkl
      hash: md5
      md5: fbdb217247903a958418728422435485
      size: 361907073
  clean_pretraining_data:
    cmd: python src/clean_pretraining_data.py --config=params.yaml
    deps:
    - path: data/raw/summary/train.src.txt
      hash: md5
      md5: c5ec83e27d31f37ddc299f22c68126ca
      size: 695194407
    - path: src/clean_pretraining_data.py
      hash: md5
      md5: bd24acad6677b0bf9834c26b45d4d622
      size: 1719
    params:
      params.yaml:
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
        data.summarization_full_txt: data/raw/summary/train.src.txt
    outs:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 6f83785aa68dc81b75faa37aa0af1a85
      size: 679267164
