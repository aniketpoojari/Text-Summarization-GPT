schema: '2.0'
stages:
  create_pretraining_data:
    cmd: python src/create_pretraining_data.py --config=params.yaml
    deps:
    - path: src/create_pretraining_data.py
      hash: md5
      md5: 46854de467615cff9329b59e0761bbfa
      size: 704
    params:
      params.yaml:
        data.pretraining_parquet: data/raw/pretraining/train-00001-of-00002.parquet
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
    outs:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 2938ccdd6d68ddb37845a262020aa61f
      size: 270479474
  create_tokenizer:
    cmd: python src/create_tokenizer.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 2938ccdd6d68ddb37845a262020aa61f
      size: 270479474
    - path: src/create_tokenizer.py
      hash: md5
      md5: bf0af90be37de8d28f541c051108a21d
      size: 660
    params:
      params.yaml:
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
        data.vocab_dir: data/tokenizer/spm_model
        hyperparameters.vocab_size: 10000
    outs:
    - path: data/tokenizer/spm_model.model
      hash: md5
      md5: 7af9c385fcb3ced1bbe55c6b15890f33
      size: 409670
  create_pretraining_split:
    cmd: python src/create_pretraining_split.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining.txt
      hash: md5
      md5: 2938ccdd6d68ddb37845a262020aa61f
      size: 270479474
    - path: data/tokenizer/spm_model.model
      hash: md5
      md5: 7af9c385fcb3ced1bbe55c6b15890f33
      size: 409670
    - path: src/create_pretraining_split.py
      hash: md5
      md5: d5af4250321f5b62c7e52f981f225520
      size: 1323
    params:
      params.yaml:
        data.pretraining_train: data/raw/pretraining/pretraining_train.pkl
        data.pretraining_txt: data/raw/pretraining/pretraining.txt
        data.pretraining_val: data/raw/pretraining/pretraining_val.pkl
        data.vocab_dir: data/tokenizer/spm_model
    outs:
    - path: data/raw/pretraining/pretraining_train.pkl
      hash: md5
      md5: 0070b22d1b69f11e4ad73fd0355c96e3
      size: 226282912
    - path: data/raw/pretraining/pretraining_val.pkl
      hash: md5
      md5: 520534386937c3074e1fbe05f41ec361
      size: 24426380
  training_pretraining:
    cmd: python src/training.py --config=params.yaml
    deps:
    - path: data/raw/pretraining/pretraining_train.pkl
      hash: md5
      md5: 0070b22d1b69f11e4ad73fd0355c96e3
      size: 226282912
    - path: data/raw/pretraining/pretraining_val.pkl
      hash: md5
      md5: 520534386937c3074e1fbe05f41ec361
      size: 24426380
    - path: src/training.py
      hash: md5
      md5: 29a1cf0ccf32fc0d085bb1f3d387c4e6
      size: 4711
    params:
      params.yaml:
        data.pretraining_train: data/raw/pretraining/pretraining_train.pkl
        data.pretraining_val: data/raw/pretraining/pretraining_val.pkl
        hyperparameters.batch_size: 32
        hyperparameters.block_size: 128
        hyperparameters.dropout: 0.2
        hyperparameters.eval_interval: 100
        hyperparameters.eval_iters: 50
        hyperparameters.learning_rate: 0.0001
        hyperparameters.max_iters: 100
        hyperparameters.n_embd: 512
        hyperparameters.n_head: 8
        hyperparameters.n_layer: 8
        hyperparameters.vocab_size: 10000
        mlflow_pretraining.experiment_name: Pretraining
        mlflow_pretraining.registered_model_name: Pretrained GPT
        mlflow_pretraining.run_name: 1st
        mlflow_pretraining.server_uri: sqlite:///mlflow.db
    outs:
    - path: training_completion.txt
      hash: md5
      md5: 8132d890ed809c771d6ca9558b0ab46d
      size: 41
  log_pretraining_model:
    cmd: python src/log_pretraining_model.py --config=params.yaml
    deps:
    - path: src/log_pretraining_model.py
      hash: md5
      md5: 4b580361fdbe807c154f56f37b56aafe
      size: 1102
    - path: training_completion.txt
      hash: md5
      md5: 8132d890ed809c771d6ca9558b0ab46d
      size: 41
    params:
      params.yaml:
        mlflow_pretraining.experiment_name: Pretraining
        mlflow_pretraining.server_uri: sqlite:///mlflow.db
    outs:
    - path: saved_models/pretrained.pth
      hash: md5
      md5: 382a00e4730119a0414e264fe8dac3fc
      size: 146466066
  create_summary_data:
    cmd: python src/create_summary_data.py --config=params.yaml
    deps:
    - path: data/raw/summary/train-00000-of-00002.parquet
      hash: md5
      md5: 0f48652dbd5ff287cc94e40944524d21
      size: 167815407
    - path: src/create_summary_data.py
      hash: md5
      md5: d6fceb53c4a7665c938daf05d07608b2
      size: 1407
    params:
      params.yaml:
        data.summarization_parquet: data/raw/summary/train-00000-of-00002.parquet
        data.vocab_dir: data/tokenizer/spm_model
        hyperparameters.block_size: 128
    outs:
    - path: data/raw/summary/filtered.parquet
      hash: md5
      md5: 8e8f8dea46cf916fae032b0efc8b6459
      size: 2033171
  create_summary_split:
    cmd: python src/create_summary_split.py --config=params.yaml
    deps:
    - path: data/raw/summary/filtered.parquet
      hash: md5
      md5: 8e8f8dea46cf916fae032b0efc8b6459
      size: 2033171
    - path: src/create_summary_split.py
      hash: md5
      md5: f5184e385955d2889a2fef983a4b2406
      size: 1435
    params:
      params.yaml:
        data.summarization_filtered_parquet: data/raw/summary/filtered.parquet
        data.train_full: data/raw/summary/train_full.pkl
        data.train_summary: data/raw/summary/train_summary.pkl
        data.val_full: data/raw/summary/val_full.pkl
        data.val_summary: data/raw/summary/val_summary.pkl
    outs:
    - path: data/raw/summary/train_full.pkl
      hash: md5
      md5: 659be1f8d37429f526888003079f7468
      size: 9126460
    - path: data/raw/summary/train_summary.pkl
      hash: md5
      md5: 5d9f67252238fe63460a59ea4f1bfd77
      size: 9126460
    - path: data/raw/summary/val_full.pkl
      hash: md5
      md5: a03378ab0f52dad2721a427ffe67440d
      size: 1014976
    - path: data/raw/summary/val_summary.pkl
      hash: md5
      md5: cff71a604184f9345069ef98d68713a5
      size: 1014976
  summary_training:
    cmd: python src/summary_training.py --config=params.yaml
    deps:
    - path: data/raw/summary/train_full.pkl
      hash: md5
      md5: 659be1f8d37429f526888003079f7468
      size: 9126460
    - path: data/raw/summary/train_summary.pkl
      hash: md5
      md5: 5d9f67252238fe63460a59ea4f1bfd77
      size: 9126460
    - path: data/raw/summary/val_full.pkl
      hash: md5
      md5: a03378ab0f52dad2721a427ffe67440d
      size: 1014976
    - path: data/raw/summary/val_summary.pkl
      hash: md5
      md5: cff71a604184f9345069ef98d68713a5
      size: 1014976
    - path: saved_models/pretrained.pth
      hash: md5
      md5: 382a00e4730119a0414e264fe8dac3fc
      size: 146466066
    - path: src/summary_training.py
      hash: md5
      md5: f8dd263c91a3e3ab2d836aa564f41e9f
      size: 4966
    params:
      params.yaml:
        data.train_full: data/raw/summary/train_full.pkl
        data.train_summary: data/raw/summary/train_summary.pkl
        data.val_full: data/raw/summary/val_full.pkl
        data.val_summary: data/raw/summary/val_summary.pkl
        hyperparameters.batch_size: 32
        hyperparameters.block_size: 128
        hyperparameters.eval_interval: 100
        hyperparameters.eval_iters: 50
        hyperparameters.learning_rate: 0.0001
        hyperparameters.max_iters: 100
        log_pretrained_model.model_dir: saved_models/pretrained.pth
        mlflow_summary.experiment_name: Summary
        mlflow_summary.registered_model_name: Summary GPT
        mlflow_summary.run_name: 1st
        mlflow_summary.server_uri: sqlite:///mlflow.db
    outs:
    - path: training_summary_completion.txt
      hash: md5
      md5: a7c6c586b9055862c3b8fd0761059e7f
      size: 41
  log_summary_model:
    cmd: python src/log_summary_model.py --config=params.yaml
    deps:
    - path: src/log_summary_model.py
      hash: md5
      md5: dabbdf6f258b35c1a41eb8f468e02fcd
      size: 1091
    - path: training_summary_completion.txt
      hash: md5
      md5: a7c6c586b9055862c3b8fd0761059e7f
      size: 41
    params:
      params.yaml:
        mlflow_summary.experiment_name: Summary
        mlflow_summary.server_uri: sqlite:///mlflow.db
    outs:
    - path: saved_models/summary.pth
      hash: md5
      md5: a5b6643b30beb3be1414ac34d7c0afb8
      size: 146465426
