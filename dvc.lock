schema: '2.0'
stages:
  clean_pretraining_data:
    cmd: python src/pretraining/clean_pretraining_data.py --config=params.yaml
    deps:
    - path: data/raw/summary/train.src.txt
      hash: md5
      md5: c5ec83e27d31f37ddc299f22c68126ca
      size: 695194407
    - path: src/pretraining/clean_pretraining_data.py
      hash: md5
      md5: 515de5ca37cea0b6086445d526efedfd
      size: 1597
    params:
      params.yaml:
        data.pretraining_pkl: data/processed/pretraining/pretraining.pkl
        data.pretraining_size: 200000
        data.summarization_full_txt: data/raw/summary/train.src.txt
    outs:
    - path: data/processed/pretraining/pretraining.pkl
      hash: md5
      md5: 5ee640f740d031b26a1d8a62b049f930
      size: 23873476
  create_pretraining_split:
    cmd: python src/pretraining/create_pretraining_split.py --config=params.yaml
    deps:
    - path: data/processed/pretraining/pretraining.pkl
      hash: md5
      md5: 5ee640f740d031b26a1d8a62b049f930
      size: 23873476
    - path: src/pretraining/create_pretraining_split.py
      hash: md5
      md5: 367c255bcd641ed223768fff9d1fbe9b
      size: 1020
    params:
      params.yaml:
        data.pretraining_pkl: data/processed/pretraining/pretraining.pkl
        data.pretraining_split: 0.7
        data.pretraining_train: data/processed/pretraining/pretraining_train.pkl
        data.pretraining_val: data/processed/pretraining/pretraining_val.pkl
    outs:
    - path: data/processed/pretraining/pretraining_train.pkl
      hash: md5
      md5: e0172ea49dddf28027db458ba142f4dd
      size: 16713211
    - path: data/processed/pretraining/pretraining_val.pkl
      hash: md5
      md5: 3af256fd7410046da422e275564159c1
      size: 7160270
  push_pretraining_data_to_s3:
    cmd: python src/pretraining/push_pretraining_data_to_s3.py --config=params.yaml
    deps:
    - path: data/processed/pretraining/pretraining_train.pkl
      hash: md5
      md5: e0172ea49dddf28027db458ba142f4dd
      size: 16713211
    - path: data/processed/pretraining/pretraining_val.pkl
      hash: md5
      md5: 3af256fd7410046da422e275564159c1
      size: 7160270
    - path: src/pretraining/push_pretraining_data_to_s3.py
      hash: md5
      md5: ab08c514374dec5f7ffb03df8a70293b
      size: 1387
    params:
      params.yaml:
        data.pretraining_s3: text-summarization-gpt-aniket
        data.pretraining_train: data/processed/pretraining/pretraining_train.pkl
        data.pretraining_val: data/processed/pretraining/pretraining_val.pkl
    outs:
    - path: push_pretraining_data_to_s3_completion.txt
      hash: md5
      md5: b46531651fcc48c745a920d4d0a8478f
      size: 52
  pretraining:
    cmd: python src/pretraining/trainingjob.py --config=params.yaml
    deps:
    - path: push_pretraining_data_to_s3_completion.txt
      hash: md5
      md5: b46531651fcc48c745a920d4d0a8478f
      size: 52
    - path: src/pretraining/code/dataloader.py
      hash: md5
      md5: e496df78be238b4310714bbd697c8286
      size: 2048
    - path: src/pretraining/code/model.py
      hash: md5
      md5: c254e80eafbfb8f4a27754e2488b4d4e
      size: 5038
    - path: src/pretraining/code/pretraining_sagemaker_deepspeed.py
      hash: md5
      md5: 22e7844a138fb6c1ce28b192fd688112
      size: 8825
    - path: src/pretraining/code/requirements.txt
      hash: md5
      md5: 43875908d73e80eff259235d0e393fd2
      size: 17
    - path: src/pretraining/trainingjob.py
      hash: md5
      md5: 1d58f8f0902f8611aebe8b0a72615e3f
      size: 3516
    params:
      params.yaml:
        hyperparameters.batch_size: 32
        hyperparameters.block_size: 128
        hyperparameters.dropout: 0.2
        hyperparameters.epochs: 1
        hyperparameters.eval_interval: 500
        hyperparameters.eval_iters: 6
        hyperparameters.learning_rate: 0.0002
        hyperparameters.max_iters: 3000
        hyperparameters.mini_batch_size: 16
        hyperparameters.n_embd: 768
        hyperparameters.n_head: 12
        hyperparameters.n_layer: 12
        hyperparameters.vocab_size: 50257
        mlflow_pretraining.experiment_name: Pretraining 2
        mlflow_pretraining.registered_model_name: Pretrained GPT
        mlflow_pretraining.run_name: 1st
        mlflow_pretraining.s3_mlruns_bucket: text-summarization-gpt-aniket-mlflow
        mlflow_pretraining.server_uri: https://dagshub.com/aniketpoojari/Text-Summarization-GPT.mlflow
        mlflow_pretraining.tracking_password: 38fa619a54d7cdde5e6dcaa55a01a1c14f329bc2
        mlflow_pretraining.tracking_username: aniketpoojari
        pytorch_estimator.entry_point: pretraining_sagemaker_deepspeed.py
        pytorch_estimator.framework_version: 2.1.0
        pytorch_estimator.instance_count: 2
        pytorch_estimator.instance_type: ml.g4dn.xlarge
        pytorch_estimator.max_run: 7200
        pytorch_estimator.max_wait: 7200
        pytorch_estimator.py_version: py310
        pytorch_estimator.role: arn:aws:iam::975050169307:role/text-to-image-role
        pytorch_estimator.s3_train_data: s3://text-summarization-gpt-aniket
        pytorch_estimator.source_dir: src/pretraining/code
        pytorch_estimator.use_spot_instances: true
    outs:
    - path: training_completion.txt
      hash: md5
      md5: ef937bd96f2f7cb47be908178cc9e8fc
      size: 41
  log_pretraining_model:
    cmd: python src/pretraining/log_pretraining_model.py --config=params.yaml
    deps:
    - path: src/pretraining/log_pretraining_model.py
      hash: md5
      md5: f083c2ba996e8f2cf95cbb0d2a852128
      size: 1473
    - path: training_completion.txt
      hash: md5
      md5: ef937bd96f2f7cb47be908178cc9e8fc
      size: 41
    params:
      params.yaml:
        mlflow_pretraining.experiment_name: Pretraining 2
        mlflow_pretraining.s3_mlruns_bucket: text-summarization-gpt-aniket-mlflow
        mlflow_pretraining.server_uri: https://dagshub.com/aniketpoojari/Text-Summarization-GPT.mlflow
    outs:
    - path: saved_models/pretrained.pth
      hash: md5
      md5: 30570d4dd68f9ebdd11073c7e96b9729
      size: 495069786
  create_summary_data:
    cmd: python src/summary/create_summary_data.py --config=params.yaml
    deps:
    - path: data/raw/summary/train.src.txt
      hash: md5
      md5: c5ec83e27d31f37ddc299f22c68126ca
      size: 695194407
    - path: data/raw/summary/train.tgt.txt
      hash: md5
      md5: 698a3c20b54e8fdb19acdc60c9b676ef
      size: 198500841
    - path: src/summary/create_summary_data.py
      hash: md5
      md5: 9c395b0aaf5b4e4b400a3fb4f44773f1
      size: 3599
    params:
      params.yaml:
        data.summarization_full_txt: data/raw/summary/train.src.txt
        data.summarization_summary_txt: data/raw/summary/train.tgt.txt
        data.summary_size: 200000
        hyperparameters.block_size: 128
    outs:
    - path: data/processed/summary/filtered.parquet
      hash: md5
      md5: abaec1661a287e5e2b4a06e7affe9c1f
      size: 37933099
  create_summary_split:
    cmd: python src/summary/create_summary_split.py --config=params.yaml
    deps:
    - path: data/processed/summary/filtered.parquet
      hash: md5
      md5: abaec1661a287e5e2b4a06e7affe9c1f
      size: 37933099
    - path: src/summary/create_summary_split.py
      hash: md5
      md5: e94393ec5bcc495c53964aee778aee83
      size: 1281
    params:
      params.yaml:
        data.summarization_filtered_parquet: data/processed/summary/filtered.parquet
        data.summary_train: data/processed/summary/train_tensor.pt
        data.summary_val: data/processed/summary/val_tensor.pt
    outs:
    - path: data/processed/summary/train_tensor.pt
      hash: md5
      md5: 9c06d1e9661170ff3b0564a51e2618a5
      size: 491521205
    - path: data/processed/summary/val_tensor.pt
      hash: md5
      md5: 0c5fef3b4fe5d636c87906004f8fbf71
      size: 122881195
  summary_finetuning:
    cmd: python src/summary/summary_training.py --config=params.yaml
    deps:
    - path: data/processed/summary/train_tensor.pt
      hash: md5
      md5: 9c06d1e9661170ff3b0564a51e2618a5
      size: 491521205
    - path: data/processed/summary/val_tensor.pt
      hash: md5
      md5: 0c5fef3b4fe5d636c87906004f8fbf71
      size: 122881195
    - path: saved_models/pretrained.pth
      hash: md5
      md5: 30570d4dd68f9ebdd11073c7e96b9729
      size: 495069786
    - path: src/summary/dataloader.py
      hash: md5
      md5: 99dee346b85571114e2141fb3d949436
      size: 1198
    - path: src/summary/loss.py
      hash: md5
      md5: 70414d8e039e0eb993b5837b7ff5a4d1
      size: 3832
    - path: src/summary/model.py
      hash: md5
      md5: c254e80eafbfb8f4a27754e2488b4d4e
      size: 5038
    - path: src/summary/summary_training.py
      hash: md5
      md5: 21c9c4db444b9178e8a9c6555482ea77
      size: 9324
    - path: training_completion.txt
      hash: md5
      md5: ef937bd96f2f7cb47be908178cc9e8fc
      size: 41
    params:
      params.yaml:
        data.summary_train: data/processed/summary/train_tensor.pt
        data.summary_val: data/processed/summary/val_tensor.pt
        hyperparameters.eval_interval: 500
        hyperparameters.eval_iters: 6
        log_pretrained_model.model_dir: saved_models/pretrained.pth
        mlflow_summary.experiment_name: Summary
        mlflow_summary.registered_model_name: Summary GPT
        mlflow_summary.run_name: 1st
        mlflow_summary.server_uri: sqlite:///mlflow.db
        summary_hyperparameters.batch_size: 16
        summary_hyperparameters.epochs: 1
        summary_hyperparameters.learning_rate: 5e-05
        summary_hyperparameters.max_iters: 10000
        summary_hyperparameters.mini_batch_size: 16
    outs:
    - path: training_summary_completion.txt
      hash: md5
      md5: 203c7228f9950034206d0f405220984d
      size: 41
  log_summary_model:
    cmd: python src/summary/log_summary_model.py --config=params.yaml
    deps:
    - path: src/summary/log_summary_model.py
      hash: md5
      md5: 22960a1cdd9460d0eddf21f67ad8f728
      size: 1241
    - path: training_summary_completion.txt
      hash: md5
      md5: 203c7228f9950034206d0f405220984d
      size: 41
    params:
      params.yaml:
        mlflow_summary.experiment_name: Summary
        mlflow_summary.server_uri: sqlite:///mlflow.db
    outs:
    - path: saved_models/summary.pth
      hash: md5
      md5: 79da2b3ee79d4e5c260f678bf0801000
      size: 495071834
